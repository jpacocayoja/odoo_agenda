<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario para el modelo Comunicado -->
     <record id="view_comunicado_form" model="ir.ui.view">
        <field name="name">comunicado.form</field>
        <field name="model">mi_modulo_academico.comunicado</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="state" widget="statusbar"/>
                    <button name="action_publish" string="Publicar" type="object" 
                            invisible="state != 'draft'"
                            class="oe_highlight"/>
                    <button name="action_archive" string="Archivar" type="object"
                            invisible="state != 'published'"
                            class="oe_highlight"/>
                    <button name="action_draft" string="Volver a Borrador" type="object"
                            invisible="state == 'draft'"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="titulo" placeholder="T√≠tulo del comunicado"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="descripcion"/>
                            <field name="enlace" widget="url"/>
                            <field name="tipo_destinatario"/>
                            <field name="curso_id" 
                                   invisible="tipo_destinatario != 'curso'"
                                   required="tipo_destinatario == 'curso'"/>
                            <field name="materia_id" 
                                   invisible="tipo_destinatario != 'materia'"
                                   required="tipo_destinatario == 'materia'"/>
                            <field name="padre_id" 
                                   invisible="tipo_destinatario != 'padre'"
                                   required="tipo_destinatario == 'padre'"/>
                            <field name="enviar_padres" 
                                   invisible="tipo_destinatario == 'padre'"
                                   help="Marque esta casilla si desea que el comunicado sea enviado tambi√©n a los padres de los estudiantes"/>
                        </group>
                        <group>
                            <!-- Secci√≥n de archivos -->
                            <field name="archivo" widget="binary" filename="archivo_nombre"/>
                            <field name="archivo_nombre" invisible="1"/>
                            <field name="archivo_url" widget="url" 
                                   string="‚¨áÔ∏è Click para descargar archivo"
                                   invisible="not archivo_url"/>
                            
                            <!-- Nueva secci√≥n de audio -->
                            <label for="audio" string="Mensaje de Voz"/>
                            <div class="o_row">
                                <field name="audio" widget="audio_recorder"/>
                                <field name="audio_nombre" invisible="1"/>
                            </div>
                            <field name="audio_url" widget="url" 
                                   string="üîä Reproducir mensaje"
                                   invisible="not audio_url"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Seguimiento de Lectura" name="tracking">
                            <group>
                                <group>
                                    <field name="total_destinatarios"/>
                                    <field name="total_leidos"/>
                                    <field name="porcentaje_lectura" widget="percentage"/>
                                </group>
                            </group>
                            <field name="tracking_ids" readonly="1">
                                <tree>
                                    <field name="persona_id"/>
                                    <field name="tipo_destinatario"/>
                                    <field name="leido"/>
                                    <field name="fecha_lectura"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>
    
    
    <!-- Vista de lista actualizada -->
    <record id="view_comunicado_tree" model="ir.ui.view">
        <field name="name">comunicado.tree</field>
        <field name="model">mi_modulo_academico.comunicado</field>
        <field name="arch" type="xml">
            <tree>
                <field name="create_date"/>
                <field name="titulo"/>
                <field name="tipo_destinatario"/>
                <field name="curso_id"/>
                <field name="materia_id"/>
                <field name="padre_id"/>
                <field name="archivo_nombre"/>
                <field name="state"/>
                <field name="archivo_url" widget="url" string="‚¨áÔ∏è Enlace" invisible="not archivo_url"/>
            </tree>
        </field>
    </record>

    <!-- Vista de b√∫squeda actualizada -->
    <record id="view_comunicado_search" model="ir.ui.view">
        <field name="name">comunicado.search</field>
        <field name="model">mi_modulo_academico.comunicado</field>
        <field name="arch" type="xml">
            <search>
                <field name="titulo"/>
                <field name="descripcion"/>
                <field name="tipo_destinatario"/>
                <field name="curso_id"/>
                <field name="materia_id"/>
                <field name="padre_id"/>
                <filter string="Con Archivo" name="con_archivo" domain="[('archivo_url', '!=', False)]"/>
                <filter string="Sin Archivo" name="sin_archivo" domain="[('archivo_url', '=', False)]"/>
                <separator/>
                <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Publicado" name="published" domain="[('state', '=', 'published')]"/>
                <filter string="Archivado" name="archived" domain="[('state', '=', 'archived')]"/>
                <group expand="0" string="Agrupar Por">
                    <filter name="group_by_tipo" string="Tipo de Destinatario" context="{'group_by': 'tipo_destinatario'}"/>
                    <filter name="group_by_curso" string="Curso" context="{'group_by': 'curso_id'}"/>
                    <filter name="group_by_materia" string="Materia" context="{'group_by': 'materia_id'}"/>
                    <filter name="group_by_state" string="Estado" context="{'group_by': 'state'}"/>
                    <filter name="group_by_month" string="Mes" context="{'group_by': 'create_date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acci√≥n de ventana -->
    <record id="action_comunicado" model="ir.actions.act_window">
        <field name="name">Comunicados</field>
        <field name="res_model">mi_modulo_academico.comunicado</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_comunicado_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crea tu primer comunicado
            </p>
            <p>
                Crea comunicados y comparte archivos a trav√©s de Cloudinary.
            </p>
        </field>
    </record>

    <!-- Men√∫ -->
    <menuitem id="menu_comunicado" 
              name="Comunicados" 
              parent="menu_mi_modulo_academico_root" 
              action="action_comunicado" 
              sequence="80"/>
</odoo>